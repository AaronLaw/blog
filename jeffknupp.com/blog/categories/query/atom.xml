<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: query | Hackers Gonna Hack]]></title>
  <link href="http://www.jeffknupp.com/blog/categories/query/atom.xml" rel="self"/>
  <link href="http://www.jeffknupp.com/"/>
  <updated>2012-07-10T06:02:38-04:00</updated>
  <id>http://www.jeffknupp.com/</id>
  <author>
    <name><![CDATA[Jeff Knupp]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Profiling Django Applications: A Journey From 1300 to 2 queries]]></title>
    <link href="http://www.jeffknupp.com/blog/2012/02/14/profiling-django-applications/"/>
    <updated>2012-02-14T09:33:00-05:00</updated>
    <id>http://www.jeffknupp.com/blog/2012/02/14/profiling-django-applications</id>
    <content type="html"><![CDATA[<p>In this post, I'll discuss profiling Django applications through a case
study in <a href="http://www.linkrdr.com">linkrdr's</a> code. Through the use of
profiling tools, I was able to reduce the number of database queries a
view was using from <strong>1300</strong> to 2.</p>

<h2>Introduction To Profiling</h2>

<p>At some point in most Django projects, some part of the application
becomes 'slow'. This doesn't have to be the case (more on that later),
but it's often the result of changes made without performance
in mind.</p>

<p>In the begining, this is actually a good thing: <strong>focus on
making it work first, then focus on making it fast</strong>. Of course, you
don't want to code yourself into a corner by writing code that "works"
but does so in a way that it will <em>never</em> be fast. Instead, you want to
keep performance in the back of your mind while implementing a solution
that makes sense.</p>

<p>Once you've proven your solution works through your automated tests
(<a href="http://www.jeffknupp.com/blog/2012/02/11/unit-testing-in-django/">You are using automated tests, right?</a>),
the next step is to make sure its performance is acceptable. Note that
I didn't say 'optimal'. <strong>Don't waste time making something faster than
it needs to be</strong>. This should be common sense but, once the optimization
bug bites, it's common for developers to go a bit off the deep end and
keep trying to find optimizations long after it's necessary.</p>

<!--more-->


<p>So you're solution works, but it's slower than what you've deemed
acceptable. What's the first step? For far too many developers, it's</p>

<ol>
<li>Fire up my editor</li>
<li>Take a look around</li>
<li>Guess what I think is causing slowness</li>
<li>Make a bunch of changes</li>
<li>Hope it got faster</li>
</ol>


<p>Wrong, wrong, wrong. If you take away one thing from the post, let this
be it: <strong>developers are notoriously bad at predicting performance
bottlenecks</strong>. People think, 'Well, I wrote it, so I should know what
could be causing slowness.' Instead of relying on faulty intuition, we should be relying on <em>data</em>.</p>

<p>Profiling is the process by which we accumulate data on the performance
of an application. This data can come in many forms, but usually is some
variation on reporting two things: the number of times a function or
line of code was executed and how much time it took to do so. For every modern
language there exist some form of profiling tools. Use them.</p>

<h2>A Case Study</h2>

<p><a href="http://www.linkrdr.com">linkrdr</a> allows, among other things, a user to
import their RSS/Atom/Twitter/Anything Else feeds and get an
inteligently laid out view of the <em>links</em> contained in their feeds. The
<code>show_items</code> view for linkrdr is responsible for retrieving the user's
current feeds, gathering the links from those feeds' entries, and
scoring, sorting, and aggregating the links for presentation.</p>

<p>When I first began work on the view, I did so with a unit test prewritten.
I needed to get that test working, so I did so in the simplest way possible. Here's what
the code looked like:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Intial show_items implementation  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">show_items</span><span class="p">(</span><span class="n">request</span><span class="p">):</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">feeds</span> <span class="o">=</span> <span class="n">Feed</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">users__id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'><span class="n">seen_links</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">LinkScore</span><span class="p">():</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">score</span><span class="p">):</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span><span class="p">]</span>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">score</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">feed</span> <span class="ow">in</span> <span class="n">feeds</span><span class="p">:</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">feed</span><span class="o">.</span><span class="n">entry_set</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">link_set</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span class='line'>            <span class="c"># determine score for link</span>
</span><span class='line'>
</span><span class='line'><span class="n">sorted_links</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">seen_links</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
</span><span class='line'>        <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;links/entries.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;links&#39;</span><span class="p">:</span> <span class="n">sorted_links</span><span class="p">,</span> <span class="p">},</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Simple, right? If someone asked you to write psuedo-code to perform this
task, I'm guessing it would look largely similar to this. Remember,
that's a good thing in the begining. We're focusing on correctness more
than performance.</p>

<p>This code turned out to be 'all right' in the performance department.
It eventually got on my nerves, though, becuase I knew it has a problem that experienced Django developers probably
spotted right away. Even though I was %99.99 percent sure I knew what
was slowing down this view, I approached optimizing this code the same
way I approach any optimization task. I began with profiling.</p>

<p>Profiling in Django is a little all over the map. There isn't really a
universally accepted solution, as you can tell by reading the
<a href="https://code.djangoproject.com/wiki/ProfilingDjango">Django wiki</a>. I've
been using
<a href="https://github.com/django-extensions/django-extensions">django-extensions</a>
for a while now, and it has a very nice profiling feature: <code>manage.py runprofileserver</code>. It starts the Django webserver with the (now unmaintained but still useful) <em>hotshot</em> profiler and writes a .prof profiling results file on every request.</p>

<p>So I fired up the profile server and navigated to my view. A .prof file
was added to my /tmp directory. To interpret it, I entered the Django
shell and did the following:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Reading the profiling stats  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">hotshot.stats</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">stats</span> <span class="o">=</span> <span class="n">hotshot</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;/path/to/file.prof&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">stats</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">,</span> <span class="s">&#39;calls&#39;</span><span class="p">)</span> <span class="c"># sort the output based on time spent</span>
</span><span class='line'><span class="ow">in</span> <span class="n">the</span> <span class="n">function</span>
</span><span class='line'><span class="n">stats</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="c"># print the top 20 culprits</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The result of this was as I expected:
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Profiling output  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>In <span class="o">[</span>6<span class="o">]</span>: stats.print_stats<span class="o">(</span>20<span class="o">)</span>
</span><span class='line'>   557944 <span class="k">function </span>calls <span class="o">(</span>485997 primitive calls<span class="o">)</span> in 3.959 seconds&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;   Ordered by: internal <span class="nb">time</span>, call count
</span><span class='line'>   List reduced from 457 to 20 due to restriction &lt;20&gt;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;   ncalls  tottime  percall  cumtime  percall filename:lineno<span class="o">(</span><span class="k">function</span><span class="o">)</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt; 1310    0.763    0.001    0.783    0.001 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/db/backends/postgresql_psycopg2/base.py:42<span class="o">(</span>execute<span class="o">)</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;68656/15272    0.485    0.000    1.099    0.000 /usr/lib/python2.7/copy.py:145<span class="o">(</span>deepcopy<span class="o">)</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;67792    0.173    0.000    0.173    0.000 /usr/lib/python2.7/copy.py:267<span class="o">(</span>_keep_alive<span class="o">)</span>
</span><span class='line'> 1310    0.152    0.000    0.155    0.000 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/db/backends/postgresql_psycopg2/base.py:116<span class="o">(</span>_cursor<span class="o">)</span>
</span><span class='line'> 3818    0.136    0.000    1.294    0.000 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/db/models/sql/query.py:223<span class="o">(</span>clone<span class="o">)</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;10041/5020    0.109    0.000    0.544    0.000 /usr/lib/python2.7/copy.py:234<span class="o">(</span>_deepcopy_tuple<span class="o">)</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt; 2344    0.089    0.000    0.106    0.000 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/db/models/base.py:275<span class="o">(</span>__init__<span class="o">)</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;8838/7636    0.076    0.000    0.575    0.000 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/utils/tree.py:55<span class="o">(</span>&lt;strong&gt;deepcopy&lt;/strong&gt;<span class="o">)</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;10258    0.067    0.000    0.072    0.000 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/utils/datastructures.py:110<span class="o">(</span>__init__<span class="o">)</span>
</span><span class='line'> 1310    0.057    0.000    0.111    0.000 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/db/models/sql/compiler.py:218<span class="o">(</span>get_default_columns<span class="o">)</span>
</span><span class='line'> 3654    0.053    0.000    1.816    0.000 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/db/models/query.py:214<span class="o">(</span>iterator<span class="o">)</span>
</span><span class='line'> 3280    0.050    0.000    2.209    0.001 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/db/models/fields/related.py:288<span class="o">(</span>__get__<span class="o">)</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;21494/19090    0.046    0.000    0.356    0.000 /usr/lib/python2.7/copy.py:226<span class="o">(</span>_deepcopy_list<span class="o">)</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt; 5021    0.045    0.000    0.326    0.000 /usr/lib/python2.7/copy.py:306<span class="o">(</span>_reconstruct<span class="o">)</span>
</span><span class='line'> 1310    0.044    0.000    0.420    0.000 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/db/models/sql/compiler.py:47<span class="o">(</span>as_sql<span class="o">)</span>
</span><span class='line'> 1310    0.040    0.000    0.069    0.000 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/db/models/sql/query.py:99<span class="o">(</span>__init__<span class="o">)</span>
</span><span class='line'> 2620    0.037    0.000    0.099    0.000 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/db/models/sql/compiler.py:749<span class="o">(</span>&amp;lt;lambda&amp;gt;<span class="o">)</span>
</span><span class='line'> 1310    0.037    0.000    0.846    0.001 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/db/backends/util.py:31<span class="o">(</span>execute<span class="o">)</span>
</span><span class='line'> 3818    0.037    0.000    1.345    0.000 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/db/models/query.py:751<span class="o">(</span>_clone<span class="o">)</span>
</span><span class='line'>10258    0.037    0.000    0.037    0.000 /home/illest/linkrdr/virtualenv/local/lib/python2.7/site-packages/django/utils/datastructures.py:105<span class="o">(</span>__new__<span class="o">)</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>As you can see, psycopg2 is calling <code>execute</code> 1310 times, which is
causing all sorts of slowness. Execute, in case you didn't guess, is the
function that executes an SQL query against the database. My view was
making <strong>1310 database queries for a user with 4 feeds</strong>.</p>

<p>Well, now we know what the cause of the slowness is. The question is: how do we fix it? I began by activating the django-debug-toolbar,
which lets you view the number of SQL queries a page generates, among
many other useful things. I confirmed that the number of queries
reported was the same in the debug-toolbar and went about optimizing the
code.</p>

<p>The first approach to optmization in Django should always be to modify the
problematic function without changing anything else. Sometimes, you won't be
able to optimize without making changes to your models or other parts
of your application, but this kind of change shouldn't be your first
inclination.</p>

<p>So I went back to my view and asked: is there a better way to get the same
data I'm currently getting? It turns out there is: using <code>select_related</code> in my query.
<a href="https://docs.djangoproject.com/en/1.1/ref/models/querysets/#select-related">select_related</a> populates your QuerySet with the records you requested
plus related records based on ForeignKeys in your model. If I could
change my query to use select related, I could drastically reduce the
number of queries the view required.</p>

<p>There was an issue, though. My models were set up so that a Link
belonged to an Entry, which belonged to a Feed, which had a set of
Users associated. I had gone from the top down: a query filtering feeds
that belonged to the current user. What I needed to do to realize the
benefit of <code>select_related</code> was to get all of the objects I needed in
one query. Since what I really needed was <code>Link</code> objects, I changed the
query to:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Changing the query  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">links</span> <span class="o">=</span> <span class="n">Link</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;entry&#39;</span><span class="p">,</span> <span class="s">&#39;entry&lt;strong&gt;feed&#39;</span><span class="p">,</span> <span class="s">&#39;url&#39;</span><span class="p">,</span> <span class="s">&#39;entry&lt;/strong&gt;url&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">entry</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">feed</span><span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">users__id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This would give me all of the links that I was interested in, plus all
of the related objects that I'd be using. I reran the view profiling and
saw something unexpected: I was still performing over 600 queries. Using
the debug-toolbar to determine the lines of code generating these
queries quickly revealed my error. When using <code>select_related</code>, you must
make sure to <em>reuse the QuerySet in subsequent code</em>. If you
accidentally use a new QuerySet (even if the objects would have been in
the original QuerySet) it will result in a new database query. This
cascades down to any other objects using the new QuerySet, and now you've
got the same issue again.</p>

<p>After making sure I reused the QuerySet throughout my view and the
functions it called, I reran the view using the debug-toolbar. Finally I
had the results I wanted: all of the data generated in just 2 queries
(the other query was the User's Session query, which can't really be
avoided). One thing you need to be aware of when using <code>select_related</code>
is that the query can get so large as to be slower than the iterative
approach. That's something I'll definitely need to keep an eye on in the
future.</p>

<h2>Cleaning Up</h2>

<p>After re-running the tests to confirm my new code worked as expected and
committing the code to git, I had one more task left: update my unit
tests to reflect my new changes. While I didn't make any functional
changes, I did make performance changes, and <strong>performance changes
should be unit tested just like functionality changes</strong>.</p>

<p>Helpfully, Django's <code>TestCase</code> class has an assertion <code>TestCase.assertNumQueries()</code>
that checks the number of queries performed during a test. I simply
added this assertion the my view test and I was done. This prevents me
from adding code in the future that increases the number of database
queries without forcing myself to decide if that's acceptable.</p>

<p>Questions or comments on <em>Profiling Django Applications</em>? Let me know in the comments below. Also, <a href="http://www.twitter.com/jeffknupp">follow me on Twitter</a> to see all of my blog posts and updates.</p>
]]></content>
  </entry>
  
</feed>


<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Unit Testing in Django - Hackers Gonna Hack</title>
  <meta name="author" content="Jeff Knupp">

  
  <meta name="description" content="As a follow-up to my post Starting a Django Project the Right Way, I wanted to talk aboue the importance of writing tests for Django applications. I &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.jeffknupp.com/blog/2012/02/11/unit-testing-in-django">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/hackersgonnahack" rel="alternate" title="Hackers Gonna Hack" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12615441-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Hackers Gonna Hack</a></h1>
  
    <h2>On Hacking and Hustling</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/hackersgonnahack" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.jeffknupp.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-me/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Unit Testing in Django</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-11T14:17:00-05:00" pubdate data-updated="true">Feb 11<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>As a follow-up to my post <a href="http://www.jeffknupp.com/blog/2012/02/09/starting-a-django-project-the-right-way/">Starting a Django Project the Right Way</a>, I wanted to talk aboue the importance of writing tests for Django applications. I previously mentioned that my first site <a href="http://www.illestrhyme.com">IllestRhyme</a>, has no app specific tests for it. This is both embarassing and true. I&#8217;ve lost countless hours to fixing problems caused by new changes. I wasn&#8217;t going to make the same mistake with <a href="http://www.linkrdr.com">linkrdr</a>. Having a set of unit tests that I can run in an automated fashion has made a world of difference.</p>

<p>The Django <code>unittest</code> framework (really the Python <code>unittest</code> framework) is both simple and powerfull. Along with the test client (<code>django.test.client.Client</code>), there&#8217;s a lot you can
do with Django right out of the box.</p>

<h2>Setup</h2>

<p>To start, we&#8217;ll want to create a dump of our database data to use during testing.</p>

<figure class='code'><figcaption><span>Dump our data</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./manage.py dumpdata --format<span class="o">=</span>json &gt; my/app/directory/initial_data.json
</span></code></pre></td></tr></table></div></figure>


<p>This will give us a json <a href="https://code.djangoproject.com/wiki/Fixtures">fixture</a> that mimics the current state of our production database. Note that since this is a fixture for <em>all</em> of the apps installed, we&#8217;ve put it in a non-standard directory. To let the test runner find our fixture, we&#8217;ll need to set <code>FIXTURE_DIRS</code> to the directory we just dumped our data to.</p>

<p>Now that we have our data copied, let&#8217;s run whatever tests our installed
apps have already:</p>

<figure class='code'><figcaption><span>Run our tests</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span> python manage.py <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>This hopefully gives us output like:</p>

<figure class='code'><figcaption><span>Test run output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>.....................................................................................................................................................................................................................................................................................................................................................................
</span><span class='line'>----------------------------------------------------------------------
</span><span class='line'>Ran 357 tests in 30.025s
</span><span class='line'>
</span><span class='line'>OK
</span></code></pre></td></tr></table></div></figure>


<p>This is also a good check of the integrity of your database, as Django
will try to load a fixture representing all of your data. If you&#8217;ve been
screwing around with the admin interface or the shell adding
and deleting records, you may have integrity errors. If you do (like I
did), you&#8217;ll have to fix them manually and re-dump your data.</p>

<!--more-->


<p>Once we&#8217;ve got the tests for other apps working, it&#8217;s time to write our
own. They&#8217;ll generally all follow the same pattern:</p>

<ol>
<li>Create a class deriving from django.test.TestCase</li>
<li>If necessary, add a setUp function to prepare data for the tests</li>
<li>Implement test functions with a name starting with &#8216;test&#8217;</li>
<li>Run the tests</li>
</ol>


<p>You should get in the habit of running the tests after each test you
create. Sometimes, you&#8217;ll write a test expecting it to pass but it will
highlight an issue in your code. If you go off and fix the issue without
running the tests again afterwards, you may have unwittingly made
another test fail with your fix.</p>

<p>We&#8217;ll be using <code>django.test.TestCase</code> as the base class for our tests
instead of Python&#8217;s <code>unittest.TestCase</code> because the Django version adds
(from the documentation):</p>

<ol>
<li>Automatic loading of fixtures</li>
<li>Wrap each test in a transaction</li>
<li>Create a TestClient instance</li>
<li>Django-specific assertions for testing for things like redirection and form errors</li>
</ol>


<p>One quick thing to note: <em>all of your test functions names must begin with
&#8216;test&#8217;</em>. If you&#8217;ve never used Python or Django&#8217;s unittest before, you
will be <strong>extremely</strong> frustrated when you define your test classes and
functions, then run the tests only to have nothing happen. There&#8217;s a
practical reason for this decision (so you can create regular functions in your
TestCase derived class), but it drives new users insane.</p>

<h2>Adding a Test</h2>

<p>Time for an example. <a href="http://www.linkrdr.com">linkrdr</a> needs to be able to look-up a URL and
determine if it&#8217;s actually a feed. Here&#8217;s a simplified version of the
code I wrote to do that:</p>

<figure class='code'><figcaption><span>Simple feed checker  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">link_types</span><span class="o">=</span> <span class="p">[</span><span class="s">&#39;application/atom+xml&#39;</span><span class="p">,</span> <span class="s">&#39;application/rss+xml&#39;</span><span class="p">,</span>
</span><span class='line'><span class="s">&#39;application/rdf+xml&#39;</span><span class="p">,</span> <span class="s">&#39;application/xml&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">is_feed</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
</span><span class='line'>    <span class="n">link_type</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">()</span><span class="o">.</span><span class="n">gettype</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">link_type</span> <span class="ow">in</span> <span class="n">link_types</span>
</span></code></pre></td></tr></table></div></figure>


<p>Simple, right? Let&#8217;s add a test for it. First we&#8217;ll remove anything
hanging around in tests.py (like the initial contents) and start with a
clean file. We&#8217;re going to create a class that derives from
<code>unittest.TestCase</code>. I&#8217;ll call mine <code>IsFeed</code> so I know from the name
what functionality it&#8217;s testing.</p>

<p>So far we have (with the required imports)</p>

<figure class='code'><figcaption><span>Our tests so far  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">unittest</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">IsFeed</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, we&#8217;d like to actually add some tests to our test case. Let&#8217;s check
to make sure my blog&#8217;s atom feed is recognized as a valid feed:</p>

<figure class='code'><figcaption><span>Adding a test  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">unittest</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">IsFeed</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Tests the functionality of utility.is_feed</span>
</span><span class='line'><span class="sd">    by getting various well-known good feeds and</span>
</span><span class='line'><span class="sd">    making sure they validate&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">test_is_feed_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Is the url a valid feed?&quot;&quot;&quot;</span>
</span><span class='line'>        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://www.jeffknupp.com/atom.xml&#39;</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">utility</span><span class="o">.</span><span class="n">is_feed</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>You&#8217;ll notice that I documented the test case, and you may be wondering
why, since I&#8217;m a lone developer. Two reasons. First, documentation is
just as useful for yourself as it is for others. Invariably, you&#8217;ll come
back to code you wrote a while ago and decide you were drunk while you
wrote it. It just makes no sense. Having documentation helps in that
respect.</p>

<p>The second reason is more subtle: to prepare to open-source the project.
My goal is to eventually open-source almost all linkrdr that isn&#8217;t
essential to the site. Anyone can write a function to check if a URL is
an RSS or atom feed. It would be nice to have one, though, that&#8217;s been
through a lot of use and checks for odd corner-cases. To that end, I&#8217;m
attempting to keep all of linkrdr PEP8 and PEP257 compliant. It&#8217;s a bit
more to write, but I&#8217;ll be glad I did once I release it into the wild.</p>

<p>Anyway, back to our tests. We should now be able to run the tests using:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span> python manage.py <span class="nb">test</span> &lt;appname&gt;
</span></code></pre></td></tr></table></div></figure>


<p>and get output similar to when we ran the testcases before.</p>

<h2>Code Coverage</h2>

<p>Tests are all well and good, but if you aren&#8217;t testing a vast majority
of your code, they&#8217;re just a false sense of security. Code coverage
tools are designed to intrument your test runs and determine what parts
of your tested code were actually exercised. With code coverage tools,
saying your code is 100% tested is not matter of opinion but rather a provable fact.</p>

<p>I use coverage.py for my code coverage. You can install it using pip via
<code>pip install coverage</code>. Once it&#8217;s installed, rerun your tests like so:</p>

<figure class='code'><figcaption><span>Running coverage.py with unit tests</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span> coverage run manage.py <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will produce an instrumentation file that you can convert to HTML
or LaTex, or view from the command line. Run</p>

<figure class='code'><figcaption><span>Viewing coverage reports</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span> coverage report
</span></code></pre></td></tr></table></div></figure>


<p>to get a snapshot of how much of your code is actually being tested by
your unit tests.</p>

<h2>More to Come</h2>

<p>I plan on continuing describing best practices for professional Django
development, started in <a href="http://www.jeffknupp.com/blog/2012/02/09/starting-a-django-project-the-right-way/">Starting a Django Project the Right Way</a> in future posts. Next time I&#8217;ll discuss the TestClient and integrating tests into your deployment system.</p>

<p>Questions or comments on <em>Unit Testing in Django</em>? Let me know in the comments below. Also, <a href="http://www.twitter.com/jeffknupp">follow me on Twitter</a> to see all of my blog posts and updates.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jeff Knupp</span></span>

      








  


<time datetime="2012-02-11T14:17:00-05:00" pubdate data-updated="true">Feb 11<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/django/'>django</a>, <a class='category' href='/blog/categories/python/'>python</a>, <a class='category' href='/blog/categories/testing/'>testing</a>, <a class='category' href='/blog/categories/unit/'>unit</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.jeffknupp.com/blog/2012/02/11/unit-testing-in-django/" data-via="jeffknupp" data-counturl="http://www.jeffknupp.com/blog/2012/02/11/unit-testing-in-django/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/02/10/introducing-linkrdr/" title="Previous Post: Introducing linkrdr">&laquo; Introducing linkrdr</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/02/14/profiling-django-applications/" title="next Post: Profiling Django Applications: A Journey From 1300 to 2 queries">Profiling Django Applications: A Journey From 1300 to 2 queries &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/10/software-optimization-a-systematic-approach/">Software Optimization: A Systematic Approach</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/31/pythons-hardest-problem/">Python's Hardest Problem</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/05/from-redis-to-memcached-to-surpdb/">From Memcached to Redis to Surpdb</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/29/single-founder-seo-building-your-personal-brand/">Single Founder SEO: Building Your Personal Brand</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/24/django-memcached-optimizing-django-through-caching/">Django Memcached: Optimizing Django Through Caching</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/jeffknupp">@jeffknupp</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jeffknupp',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("jeffknupp", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/jeffknupp" class="twitter-follow-button" data-show-count="false">Follow @jeffknupp</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Jeff Knupp -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

<a title="Real Time Web Analytics" href="http://getclicky.com/66528953"><img alt="Real Time Web Analytics" src="//static.getclicky.com/media/links/badge.gif" border="0" /></a>
<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(66535137); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/66535137ns.gif" /></p></noscript>
</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'hackersgonnahack';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.jeffknupp.com/blog/2012/02/11/unit-testing-in-django/';
        var disqus_url = 'http://www.jeffknupp.com/blog/2012/02/11/unit-testing-in-django/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
